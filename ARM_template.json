{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "String",
            "defaultValue": "dsadmin",
            "metadata": {
                "description": "DataSunrise VM Scale Set Nodes OS User Name"
            }
        },
        "adminPassword": {
            "type": "SecureString",
            "metadata": {
                "description": "DataSunrise VM Scale Set Nodes OS User Password"
            }
        },
        "adminSSHPubKeyId": {
            "type": "String",
            "metadata": {
                "description": "The Fully Qualified SSH Public Key ResourceId"
            }
        },
        "deploymentPrefix": {
            "type": "String",
            "metadata": {
                "description": "Deployment name for this configuration"
            }
        },
        "networkSecurityGroupName": {
            "type": "String",
            "defaultValue": "DSClusterNSG",
            "metadata": {
                "description": "Name of the Network Security Group for DS Cluster resources"
            }
        },
        "roleName": {
            "defaultValue": "[newGuid()]",
            "type": "String",
            "metadata": {
                "description": "Role Name to be assigned to the created Managed Identity. Must be Guid"
            }
        },
        "vmSize": {
            "defaultValue": "Standard_B2ms",
            "type": "String",
            "metadata": {
                "description": "Size of the Virtual Machine. Depends on the Location and Availability Set"
            }
        },
        "vmCount": {
            "defaultValue": "2",
            "type": "String",
            "metadata": {
                "description": "The number of Virtual machines in the Scale Set"
            }
        },
        "loadBalancerType": {
            "defaultValue": "public",
            "allowedValues": [
                "public",
                "private"
            ],
            "type": "String",
            "metadata": {
                "description": "The type of the Load Balancer that will be used to access DataSunrise environment"
            }
        },
        "subnetResourceGroupName": {
            "type": "String",
            "metadata": {
                "description": "Name of the resource group where the Subnet is stored"
            }
        },
        "virtualNetworkName": {
            "type": "String",
            "metadata": {
                "description": "The virtual network name to deploy DataSunrise resources to"
            }
        },
        "subnetNameForScaleSet": {
            "type": "String",
            "metadata": {
                "description": "Subnet Name to deploy DataSunrise VM Scale Set to"
            }
        },
        "subnetNameForConfigurationDB": {
            "type": "String",
            "metadata": {
                "description": "Subnet Name to deploy DataSunrise Dictionary and Audit Databases to"
            }
        },
        "linkToDSBuild": {
            "type": "String",
            "defaultValue": "https://update.datasunrise.com/get-last-datasunrise/index?cloud=general&os=rhel8",
            "metadata": {
                "description": "Link to the DataSunrise build installer"
            }
        },
        "DSAdminPassword": {
            "type": "SecureString",
            "metadata": {
                "description": "DS Web-UI admin console user password"
            }
        },
        "DSLicenseKey": {
            "type": "String",
            "metadata": {
                "description": "DS license key"
            }
        },
        "DictionaryDatabaseName": {
            "type": "String",
            "defaultValue": "dsdict",
            "metadata": {
                "description": "Dictionary database name to be created to store DataSunrise Configuration data"
            }
        },
        "DictionaryDatabaseAdministratorLogin": {
            "defaultValue": "dsuser",
            "type": "String",
            "metadata": {
                "description": "Administrator login for Dictionary and Audit database servers"
            }
        },
        "DictionaryDatabaseAdministratorLoginPassword": {
            "minLength": 8,
            "type": "SecureString",
            "metadata": {
                "description": "Administrator password for Dictionary and Audit database servers"
            }
        },
        "DatabaseBackupRetentionDays": {
            "defaultValue": 7,
            "type": "Int",
            "metadata": {
                "description": "Dictionary and Audit database servers backup retention days"
            }
        },
        "AuditDatabaseName": {
            "type": "String",
            "defaultValue": "dsaudit",
            "metadata": {
                "description": "Audit database name to store the events logged by DataSunrise"
            }
        },
        "AuditDatabaseAdministratorLogin": {
            "defaultValue": "dsuser",
            "type": "String",
            "metadata": {
                "description": "Administrator login for Dictionary and Audit database servers"
            }
        },
        "AuditDatabaseAdministratorLoginPassword": {
            "minLength": 8,
            "type": "SecureString",
            "metadata": {
                "description": "Administrator password for Dictionary and Audit database servers"
            }
        },
        "TargetDBType": {
            "allowedValues": [
                "postgresql",
                "mysql",
                "mssql",
                "oracle"
            ],
            "type": "String",
            "metadata": {
                "description": "Target database type"
            }
        },
        "TargetDBName": {
            "type": "String",
            "metadata": {
                "description": "Target database name. For example, postgres"
            }
        },
        "TargetDBHost": {
            "type": "String",
            "metadata": {
                "description": "Target database host. For example, postgresqlserver.postgres.database.azure.com"
            }
        },
        "TargetDBPort": {
            "type": "Int",
            "metadata": {
                "description": "Target database port. For example, 5432"
            }
        },
        "TargetDBLogin": {
            "type": "String",
            "metadata": {
                "description": "Target database login. For example, postgres"
            }
        },
        "TargetDBLoginPassword": {
            "type": "SecureString",
            "metadata": {
                "description": "Target database login password"
            }
        }
    },
    "variables": {
        "AuditDatabaseType": "postgresql",
        "AuditDatabasePort": "5432",
        "AuditServerName": "[concat(parameters('AuditDatabaseName'),'-',uniqueString(resourceGroup().id))]",
        "bePoolName": "[concat(variables('vmScaleSetName'), 'bepool')]",
        "DictionaryDatabasePort": "5432",
        "DictionaryDatabaseType": "postgresql",
        "DictionaryServerName": "[concat(parameters('DictionaryDatabaseName'),'-',uniqueString(resourceGroup().id))]",
        "ds_serverName": "[concat('ds-',uniqueString(resourceGroup().id))]",
        "TargetDBInstanceName": "[parameters('TargetDBHost')]",
        "imagePublisher": "datasunrise",
        "imageOffer": "datasunrise-database-security-suite",
        "imageSKU": "datasunrise",
        "keysPermissions": [
            "get"
        ],
        "keyVaultName": "[concat(parameters('deploymentPrefix'), 'KeyVault')]",
        "loadBalancerdnsLabelPrefix": "[concat(parameters('deploymentPrefix'),'lb')]",
        "loadBalancerFrontendIPName": "LoadBalancerFrontEnd",
        "loadBalancerNamePublic": "[concat(parameters('deploymentPrefix'), 'LoadBalancerPublic')]",
        "loadBalancerNamePrivate": "[concat(parameters('deploymentPrefix'), 'LoadBalancerPrivate')]",
        "loadBalancerProbeName": "DSLBHealthProbe",
        "loadBalancerPublicIPName": "DSLB-ip",
        "loadBalancerSKUName": "Standard",
        "location": "[resourceGroup().location]",
        "managedIdentityName": "[concat(parameters('deploymentPrefix'), '-datasunrise-uai')]",
        "azureIdentity": "[concat('/subscriptions/', subscription().subscriptionId,'/resourcegroups/', resourcegroup().name,'/providers/Microsoft.ManagedIdentity/userAssignedIdentities/',variables('managedIdentityName'))]",
        "networkInterfaceName": "[concat(variables('vmNameScale'),'NIC')]",
        "privateDnsZone": "[concat(parameters('deploymentPrefix'), 'privateDnsZone.postgres.database.azure.com')]",
        "skuCapacity": 2,
        "skuSizeGB": 128,
        "storageAccountName": "[concat(parameters('deploymentPrefix'),uniqueString(resourceGroup().id))]",
        "subnetRef": "[resourceId(parameters('subnetResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets/', parameters('virtualNetworkName'), parameters('subnetNameforScaleSet'))]",
        "tenantId": "[subscription().tenantId]",
        "virtualNetworkLink": "virtualNetworkLink",
        "vmNameScale": "VMScale",
        "vmScaleSetName": "[concat(parameters('deploymentPrefix'),'-datasunrise-vmss')]",
        "vmAutoScaleSettings": "[concat(parameters('deploymentPrefix'), 'AutoScaleSettings')]"
    },
    "resources": [
        {
            "type": "Microsoft.KeyVault/vaults",
            "apiVersion": "2021-04-01-preview",
            "name": "[variables('keyVaultName')]",
            "location": "[variables('location')]",
            "properties": {
                "enabledForDeployment": true,
                "enabledForDiskEncryption": true,
                "enableSoftDelete": false,
                "enabledForTemplateDeployment": true,
                "tenantId": "[variables('tenantId')]",
                "accessPolicies": [
                    {
                        "objectId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2018-11-30').principalId]",
                        "tenantId": "[variables('tenantId')]",
                        "permissions": {
                            "keys": "[variables('keysPermissions')]",
                            "secrets": [
                                "set",
                                "get",
                                "list",
                                "purge",
                                "delete",
                                "recover"
                            ]
                        }
                    }
                ],
                "sku": {
                    "name": "Standard",
                    "family": "A"
                },
                "networkAcls": {
                    "defaultAction": "Allow",
                    "bypass": "AzureServices"
                }
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2021-04-01-preview",
            "name": "[concat(variables('keyVaultName'), '/dsSecretAdminPassword')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            ],
            "properties": {
                "value": "[parameters('DSAdminPassword')]"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2021-04-01-preview",
            "name": "[concat(variables('keyVaultName'), '/dsSecretTargetAdminPassword')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            ],
            "properties": {
                "value": "[parameters('TargetDBLoginPassword')]"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2021-04-01-preview",
            "name": "[concat(variables('keyVaultName'), '/dsSecretDictionaryAdminPassword')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            ],
            "properties": {
                "value": "[parameters('DictionaryDatabaseAdministratorLoginPassword')]"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2021-04-01-preview",
            "name": "[concat(variables('keyVaultName'), '/dsSecretAuditAdminPassword')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            ],
            "properties": {
                "value": "[parameters('AuditDatabaseAdministratorLoginPassword')]"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2021-04-01-preview",
            "name": "[concat(variables('keyVaultName'), '/dsSecretLicenseKey')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            ],
            "properties": {
                "value": "[parameters('DSLicenseKey')]"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2018-09-01-preview",
            "name": "[parameters('roleName')]",
            "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]"
            ],
            "properties": {
                "roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2018-11-30').principalId]",
                "scope": "[resourceGroup().id]",
                "principalType": "ServicePrincipal"
            }
        },
        {
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "apiVersion": "2018-11-30",
            "name": "[variables('managedIdentityName')]",
            "location": "[variables('location')]"
        },
        {
            "condition": "[equals(parameters('loadBalancerType'),'private')]",
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2021-03-01",
            "name": "[variables('loadBalancerNamePrivate')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('loadBalancerPublicIPName'))]"
            ],
            "sku": {
                "name": "[variables('loadBalancerSKUName')]"
            },
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "[variables('loadBalancerFrontendIPName')]",
                        "properties": {
                            "subnet": {
                                "id": "[variables('subnetRef')]"
                            },
                            "privateIPAllocationMethod": "Dynamic"
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "[variables('bePoolName')]"
                    }
                ],
                "probes": [
                    {
                        "name": "[variables('loadBalancerProbeName')]",
                        "properties": {
                            "protocol": "tcp",
                            "port": 11000,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    }
                ],
                "loadBalancingRules": [
                    {
                        "name": "DSLBRule",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('loadBalancerNamePrivate'), variables('loadBalancerFrontendIPName'))]"
                            },
                            "backendAddressPool": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerNamePrivate'), variables('bePoolName'))]"
                            },
                            "frontendPort": 11000,
                            "backendPort": 11000,
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 15,
                            "protocol": "Tcp",
                            "enableTcpReset": true,
                            "loadDistribution": "Default",
                            "disableOutboundSnat": true,
                            "probe": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerNamePrivate'), variables('loadBalancerProbeName'))]"
                            }
                        }
                    },
                    {
                        "name": "DSLB-TDBProxyRule",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('loadBalancerNamePrivate'), variables('loadBalancerFrontendIPName'))]"
                            },
                            "backendAddressPool": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerNamePrivate'), variables('bePoolName'))]"
                            },
                            "frontendPort": "[parameters('TargetDBPort')]",
                            "backendPort": "[parameters('TargetDBPort')]",
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 15,
                            "protocol": "Tcp",
                            "enableTcpReset": true,
                            "loadDistribution": "Default",
                            "disableOutboundSnat": true,
                            "probe": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerNamePrivate'), variables('loadBalancerProbeName'))]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "condition": "[equals(parameters('loadBalancerType'),'public')]",
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2021-03-01",
            "name": "[variables('loadBalancerNamePublic')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('loadBalancerPublicIPName'))]"
            ],
            "sku": {
                "name": "[variables('loadBalancerSKUName')]"
            },
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "[variables('loadBalancerFrontendIPName')]",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('loadBalancerPublicIPName'))]"
                            }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "[variables('bePoolName')]"
                    }
                ],
                "probes": [
                    {
                        "name": "[variables('loadBalancerProbeName')]",
                        "properties": {
                            "protocol": "tcp",
                            "port": 11000,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    }
                ],
                "outboundRules": [
                    {
                        "name": "OutboundAccess",
                        "properties": {
                            "allocatedOutboundPorts": 10000,
                            "protocol": "All",
                            "enableTcpReset": false,
                            "idleTimeoutInMinutes": 15,
                            "backendAddressPool": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerNamePublic'),variables('bePoolName'))]"
                            },
                            "frontendIPConfigurations": [
                                {
                                    "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('loadBalancerNamePublic'), variables('loadBalancerFrontendIPName'))]"
                                }
                            ]
                        }
                    }
                ],
                "loadBalancingRules": [
                    {
                        "name": "DSLB-WebUIRule",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('loadBalancerNamePublic'), variables('loadBalancerFrontendIPName'))]"
                            },
                            "backendAddressPool": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerNamePublic'), variables('bePoolName'))]"
                            },
                            "frontendPort": 11000,
                            "backendPort": 11000,
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 15,
                            "protocol": "Tcp",
                            "enableTcpReset": true,
                            "loadDistribution": "Default",
                            "disableOutboundSnat": true,
                            "probe": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerNamePublic'), variables('loadBalancerProbeName'))]"
                            }
                        }
                    },
                    {
                        "name": "DSLB-TDBProxyRule",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('loadBalancerNamePublic'), variables('loadBalancerFrontendIPName'))]"
                            },
                            "backendAddressPool": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerNamePublic'), variables('bePoolName'))]"
                            },
                            "frontendPort": "[parameters('TargetDBPort')]",
                            "backendPort": "[parameters('TargetDBPort')]",
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 15,
                            "protocol": "Tcp",
                            "enableTcpReset": true,
                            "loadDistribution": "Default",
                            "disableOutboundSnat": true,
                            "probe": {
                                "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerNamePublic'), variables('loadBalancerProbeName'))]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/privateDnsZones",
            "apiVersion": "2018-09-01",
            "name": "[variables('privateDnsZone')]",
            "location": "global",
            "properties": {}
        },
        {
            "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
            "apiVersion": "2018-09-01",
            "name": "[concat(variables('privateDnsZone'), '/', variables('virtualNetworkLink'))]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZone'))]"
            ],
            "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                    "id": "[resourceId(parameters('subnetResourceGroupName'), 'Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
                }
            }
        },
        {
            "type": "Microsoft.DBforPostgreSQL/flexibleServers",
            "apiVersion": "2021-06-01",
            "name": "[variables('DictionaryServerName')]",
            "location": "[variables('location')]",
            "sku": {
                "name": "Standard_D4ds_v4",
                "tier": "GeneralPurpose"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones/virtualNetworkLinks', variables('privateDnsZone'), variables('virtualNetworkLink'))]"
            ],
            "properties": {
                "version": "14",
                "administratorLogin": "[parameters('DictionaryDatabaseAdministratorLogin')]",
                "administratorLoginPassword": "[parameters('DictionaryDatabaseAdministratorLoginPassword')]",
                "storage": {
                    "storageSizeGB": "[variables('skuSizeGB')]"
                },
                "backup": {
                    "backupRetentionDays": "[parameters('DatabaseBackupRetentionDays')]",
                    "geoRedundantBackup": "Disabled"
                },
                "network": {
                    "delegatedSubnetResourceId": "[resourceID(parameters('subnetResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets/', parameters('virtualNetworkName'), parameters('subnetNameforConfigurationDB'))]",
                    "PrivateDnsZoneArmResourceId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZone'))]"
                }
            },
            "resources": [
                {
                    "type": "databases",
                    "name": "[parameters('DictionaryDatabaseName')]",
                    "apiVersion": "2021-06-01",
                    "dependsOn": [
                        "[variables('DictionaryServerName')]"
                    ],
                    "properties": {
                        "charset": "UTF8"
                    }
                }
            ]

        },
        {
            "type": "Microsoft.DBforPostgreSQL/flexibleServers",
            "apiVersion": "2021-06-01",
            "name": "[variables('AuditServerName')]",
            "location": "[variables('location')]",
            "sku": {
                "name": "Standard_D4ds_v4",
                "tier": "GeneralPurpose"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones/virtualNetworkLinks', variables('privateDnsZone'), variables('virtualNetworkLink'))]"
            ],
            "properties": {
                "version": "14",
                "administratorLogin": "[parameters('DictionaryDatabaseAdministratorLogin')]",
                "administratorLoginPassword": "[parameters('DictionaryDatabaseAdministratorLoginPassword')]",
                "storage": {
                    "storageSizeGB": "[variables('skuSizeGB')]"
                },
                "backup": {
                    "backupRetentionDays": "[parameters('DatabaseBackupRetentionDays')]",
                    "geoRedundantBackup": "Disabled"
                },
                "network": {
                    "delegatedSubnetResourceId": "[resourceID(parameters('subnetResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets/', parameters('virtualNetworkName'), parameters('subnetNameforConfigurationDB'))]",
                    "PrivateDnsZoneArmResourceId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZone'))]"
                }
            },
            "resources": [
                {
                    "type": "databases",
                    "apiVersion": "2021-06-01",
                    "name": "[parameters('AuditDatabaseName')]",
                    "dependsOn": [
                        "[variables('AuditServerName')]"
                    ],
                    "properties": {
                        "charset": "UTF8"
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2016-01-01",
            "name": "[variables('storageAccountName')]",
            "location": "[variables('location')]",
            "sku": {
                "name": "Standard_LRS"
            },
            "kind": "Storage",
            "properties": {}
        },
        {
            "type": "Microsoft.Network/publicIpAddresses",
            "apiVersion": "2020-06-01",
            "name": "[variables('loadBalancerPublicIPName')]",
            "location": "[variables('location')]",
            "sku": {
                "name": "[variables('loadBalancerSKUName')]"
            },
            "properties": {
                "publicIpAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4",
                "dnsSettings": {
                    "domainNameLabel": "[variables('loadBalancerdnsLabelPrefix')]"
                },
                "idleTimeoutInMinutes": 4
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2020-06-01",
            "name": "[parameters('networkSecurityGroupName')]",
            "location": "[variables('location')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "Rule_TargetDBPortAccess",
                        "properties": {
                            "priority": 900,
                            "protocol": "TCP",
                            "access": "Allow",
                            "direction": "Inbound",
                            "sourceAddressPrefix": "*",
                            "sourcePortRange": "*",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "destinationPortRange": "[parameters('TargetDBPort')]"
                        }
                    },
                    {
                        "name": "Rule_DSWebUIAccess",
                        "properties": {
                            "priority": 1000,
                            "protocol": "TCP",
                            "access": "Allow",
                            "direction": "Inbound",
                            "sourceAddressPrefix": "*",
                            "sourcePortRange": "*",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "destinationPortRange": "11000"
                        }
                    },
                    {
                        "name": "Rule_SSHAccess",
                        "properties": {
                            "priority": 1010,
                            "protocol": "TCP",
                            "access": "Allow",
                            "direction": "Inbound",
                            "sourceAddressPrefix": "*",
                            "sourcePortRange": "*",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "destinationPortRange": "22"
                        }
                    },
                    {
                        "name": "Outbound",
                        "properties": {
                            "priority": 1000,
                            "protocol": "TCP",
                            "access": "Allow",
                            "direction": "Outbound",
                            "sourceAddressPrefix": "*",
                            "sourcePortRange": "*",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "22"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "apiVersion": "2019-03-01",
            "name": "[variables('vmScaleSetName')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups/', parameters('networkSecurityGroupName'))]"
            ],
            "sku": {
                "name": "[parameters('vmSize')]",
                "tier": "Standard",
                "capacity": "[variables('skuCapacity')]"
            },
            "identity": {
                "type": "userAssigned",
                "userAssignedIdentities": {
                    "[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities/',variables('managedIdentityName'))]": {}
                }
            },
            "plan": {
                "name": "[variables('imageSKU')]",
                "product": "[variables('imageOffer')]",
                "publisher": "[variables('imagePublisher')]"
            },
            "properties": {
                "upgradePolicy": {
                    "mode": "Automatic"
                },
                "overprovision": false,
                "virtualMachineProfile": {
                    "storageProfile": {
                        "osDisk": {
                            "createOption": "fromImage",
                            "caching": "ReadWrite"
                        },
                        "imageReference": {
                            "publisher": "[variables('imagePublisher')]",
                            "offer": "[variables('imageOffer')]",
                            "sku": "[variables('imageSKU')]",
                            "version": "latest"
                        }
                    },
                    "osProfile": {
                        "computerNamePrefix": "[variables('ds_serverName')]",
                        "computerName": "[variables('vmNameScale')]",
                        "adminUsername": "[parameters('adminUsername')]",
                        "adminPassword": "[parameters('adminPassword')]",
                        "linuxConfiguration": {
                            "ssh": {
                                "publicKeys": [
                                    {
                                        "keyData": "[reference(parameters('adminSSHPubKeyId'), '2019-12-01').publicKey]",
                                        "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]"
                                    }
                                ]
                            }
                        }
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "[variables('networkInterfaceName')]",
                                "properties": {
                                    "primary": true,
                                    "ipConfigurations": [
                                        {
                                            "name": "ipconfig1",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[variables('subnetRef')]"
                                                },
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', if(equals(parameters('loadBalancerType'),'private'), variables('loadBalancerNamePrivate'), variables('loadBalancerNamePublic')), variables('bePoolName'))]"
                                                    }
                                                ]
                                            }
                                        }
                                    ],
                                    "networkSecurityGroup": {
                                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups',parameters('networkSecurityGroupName'))]"
                                    }
                                }
                            }
                        ]
                    },
                    "extensionProfile": {
                        "extensions": [
                            {
                                "name": "dsinstallScriptScale",
                                "properties": {
                                    "publisher": "Microsoft.Azure.Extensions",
                                    "type": "CustomScript",
                                    "typeHandlerVersion": "2.1",
                                    "autoUpgradeMinorVersion": true,
                                    "settings": {
                                        "fileUris": [
                                            "https://raw.githubusercontent.com/datasunrise-github/azure-template/main/ds-params.sh",
                                            "https://raw.githubusercontent.com/datasunrise-github/azure-template/main/ds-pre-setup.sh",
                                            "https://raw.githubusercontent.com/datasunrise-github/azure-template/main/ds-setup.sh",
                                            "https://raw.githubusercontent.com/datasunrise-github/azure-template/main/ds-install.sh"
                                        ]
                                    },
                                    "protectedSettings": {
                                        "commandToExecute": "[concat('./ds-install.sh ', variables('azureIdentity'),' \"',parameters('linkToDSBuild'),'\" \"', variables('DictionaryDatabaseType'),'\" ',reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers/', variables('DictionaryServerName'))).fullyQualifiedDomainName, ' ', variables('DictionaryDatabasePort'), ' \"', parameters('DictionaryDatabaseName'), '\" ', parameters('DictionaryDatabaseAdministratorLogin'), ' \"', variables('AuditDatabaseType'), '\" ',reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers/',variables('AuditServerName'))).fullyQualifiedDomainName, ' ', variables('AuditDatabasePort'), ' \"', parameters('AuditDatabaseName'), '\" \"', parameters('AuditDatabaseAdministratorLogin'), '\" \"', variables('ds_serverName'), '\" \"', variables('keyVaultName'),'\" \"',variables('TargetDBInstanceName'),'\" \"',parameters('TargetDBPort'),'\" \"', parameters('TargetDBType'),'\" \"',parameters('TargetDBHost'),'\" \"', parameters('TargetDBName'),'\" \"', parameters('TargetDBLogin'),'\" ','2>&1 | tee -a /tmp/ds-install-output.log')]"
                                    }
                                }
                            }
                        ]
                    }
                }
            }
        },
        {
            "type": "microsoft.insights/autoscalesettings",
            "apiVersion": "2015-04-01",
            "name": "[variables('vmAutoScaleSettings')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmScaleSetName'))]"
            ],
            "properties": {
                "name": "[variables('vmAutoScaleSettings')]",
                "profiles": [
                    {
                        "name": "vmAutoScale",
                        "capacity": {
                            "minimum": "2",
                            "maximum": "2",
                            "default": "[parameters('vmCount')]"
                        },
                        "rules": []
                    }
                ],
                "enabled": true,
                "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmScaleSetName'))]"
            }
        }
    ],
    "outputs": {
        "launchCommandString": {
            "type": "string",
            "value": "[concat('./ds-install.sh ', variables('azureIdentity'),' \"',parameters('linkToDSBuild'),'\" \"', variables('DictionaryDatabaseType'),'\" ',reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers/', variables('DictionaryServerName'))).fullyQualifiedDomainName, ' ', variables('DictionaryDatabasePort'), ' \"', parameters('DictionaryDatabaseName'), '\" ', parameters('DictionaryDatabaseAdministratorLogin'), ' \"', variables('AuditDatabaseType'), '\" ',reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers/',variables('AuditServerName'))).fullyQualifiedDomainName, ' ', variables('AuditDatabasePort'), ' \"', parameters('AuditDatabaseName'), '\" \"', parameters('AuditDatabaseAdministratorLogin'), '\" \"', variables('ds_serverName'), '\" \"', variables('keyVaultName'),'\" \"',variables('TargetDBInstanceName'),'\" \"',parameters('TargetDBPort'),'\" \"', parameters('TargetDBType'),'\" \"',parameters('TargetDBHost'),'\" \"', parameters('TargetDBName'),'\" \"', parameters('TargetDBLogin'),'\" ', parameters('TargetDBPort'),' 2>&1 | tee -a /tmp/ds-setup-output.log')]"
        },
        "DataSunriseLBEndpointWebUI": {
            "type": "string",
            "value": "[concat('https://',reference(resourceId('Microsoft.Network/publicIPAddresses', variables('loadBalancerPublicIPName'))).ipAddress,':11000')]"
        }
    }
}